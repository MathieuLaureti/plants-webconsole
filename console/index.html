<!DOCTYPE html>
<html lang="en">
    <script src="https://cdn.tailwindcss.com"></script>   
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
      @font-face {
        font-family: 'OCRB'; 
        src: url('./OCRBRegular.ttf') format('truetype');
      }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        clifford: '#da373d',
                        'bg-dark': 'oklch(0.1 0.025 247)',
                        bg: 'oklch(0.15 0.025 247)',
                        'bg-light': 'oklch(0.2 0.025 247)',
                        text: 'oklch(0.96 0.05 247)',
                        'text-muted': 'oklch(0.76 0.05 247)',
                        highlight: 'oklch(0.5 0.05 247)',
                        border: 'oklch(0.4 0.05 247)',
                        'border-muted': 'oklch(0.3 0.05 247)',
                        primary: 'oklch(0.76 0.1 247)',
                        secondary: 'oklch(0.76 0.1 67)',
                        danger: 'oklch(0.7 0.05 30)',
                        warning: 'oklch(0.7 0.05 100)',
                        success: 'oklch(0.7 0.05 160)',
                        info: 'oklch(0.7 0.05 260)',
                    },
                    fontFamily: {
                        'sans': ['OCRB', 'monospace'],
                    }
                }
            }
        }
    </script>
    <script src="index.js"></script>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        
        <title>Web Console</title>
        <link rel="stylesheet" href="./style.css">
        <link rel="icon" href="./favicon.ico" type="image/x-icon">
    </head>
    <body class="bg-bg-dark">
        <main>
            <div class= "flex flex-row bg-bg border border-border rounded-xl p-2 w-[1250px] mx-auto max-[1250px]:flex-col max-[1250px]:max-w-[750px] max-[1250px]:min-w-[400px]">
                <div class="w-[484px] pr-2 flex-col h-[749px] max-[1250px]:w-full max-[1250px]:h-auto max-[1250px]:mt-4">
                    <h2 class="text-4xl mb-1 xl:font-Roboto-serif font-semibold px-auto text-text bg-bg-light border border-border w-full rounded-xl text-center h-1/12">Temperature °C</h2>
                    <div class="flex-1 relative h-[326px] max-[1250px]:h-[200px] ">
                        <canvas id="tempChart" class="w-full h-5/12"></canvas>
                    </div>
                    
                    <h2 class="text-4xl my-1 xl:font-Roboto-serif font-semibold px-auto text-text bg-bg-light border border-border w-full rounded-xl text-center h-1/12">Humidity</h2>
                    <div class="flex-1 relative h-[326px] max-[1250px]:h-[200px]">
                        <canvas id="humChart" class="w-full h-full"></canvas>
                    </div>
                </div>
                <div class="max-w-[750px] min-w-[400px] max-[1250px]:order-first">
                    <div class="h-1/12">
                        <h1 class="text-4xl xl:font-Roboto-serif font-semibold px-auto text-text bg-bg-light border border-border w-full rounded-xl text-center h-full">Plant Console</h1>
                    </div>
                    <div class="h-3/4 mt-2">
                        <img id="last_image_offset" src="https://placehold.co/1600x1200" class=" bg-bg-light border border-border w-full rounded-xl h-full">
                    </div>
                    <div class="flex w-full h-1/12 mt-2">
                        <button id="prev" class="bg-bg-light rounded-xl text-text text-2xl xl:font-Roboto-serif font-semibold w-1/3 mr-[2px] h-16 border border-border p-2"><</button>
                        <button id="camera_button" class="bg-bg-light rounded-xl text-text text-xl md:text-2xl w-1/3 mx-2 h-16 border border-border p-2">Camera 1</button>
                        <button id="next" class="bg-bg-light rounded-xl text-text text-2xl xl:font-Roboto-serif font-semibold w-1/3 ml-[2px] h-16 border border-border p-2">></button>
                    </div>
                    <div class="flex w-full h-1/12 mt-2">
                    </div>
                    <div class="flex w-full h-1/12 mt-2">
                        <button id="timestamp" class="bg-bg-light rounded-xl text-text text-xs sm:text-l w-1/3 mr-2 h-12 border border-border p-2 text-center">[date]</h1>
                        <button id="day_week_month" class="bg-bg-light rounded-xl text-text text-2xl w-1/3 mx-2 h-12 border border-border p-2">day</button>
                        <button id="slideshow" class="bg-bg-light rounded-xl text-text text-2xl w-1/3 ml-2 h-12 border border-border p-2">▶</button>
                    </div>
                </div>
            </div>
        </main>

        <script>
            const API_URL = 'https://homelabdu204.ca/plants/api/get_THs';
            function renderChart(canvasId, label, dataArray, borderColor, unit) {
                const ctx = document.getElementById(canvasId).getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dataArray.labels, 
                        datasets: [{
                            label: label,
                            data: dataArray.values,
                            borderColor: borderColor,
                            tension: 0.1,
                            fill: false,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false 
                            }
                        },
                        scales: {
                            x: {
                                display: false 
                            },
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: false,
                                    text: unit
                                }
                            }
                        }
                    }
                });
            }
            async function fetchAndRenderCharts() {
                try {
                    const response = await fetch(API_URL);
                    if (!response.ok) {
                        console.error(`HTTP error! status: ${response.status}`);
                        return;
                    }
                    const rawData = await response.json();
                    const data = rawData.reverse(); 
                    const labels = data.map(d => d.timestamp.replace('_', ' '));
                    const temperatures = data.map(d => d.temperature);
                    const humidities = data.map(d => d.humidity);
                    renderChart('tempChart', 'Temperature', {labels: labels, values: temperatures}, 'rgb(255, 99, 132)', 'Temperature (°C)');
                    renderChart('humChart', 'Humidity', {labels: labels, values: humidities}, 'rgb(75, 192, 192)', 'Humidity (%)');
                } catch (error) {
                    console.error('Error fetching or processing data:', error);
                    document.getElementById('tempChart').innerHTML = 'Could not load data.';
                }
            }
            window.onload = fetchAndRenderCharts;
            setInterval(fetchAndRenderCharts, 300000);
        </script>

        <script>
            let offset = 0;
            let camera_id = 1;
            let mode = "day";
            document.getElementById('next').addEventListener('click', () => {
            offset++;
            getLatestOffset(offset,camera_id);
            });
            
            document.getElementById('prev').addEventListener('click', () => {
            if (offset > 0) {
                offset--;
                getLatestOffset(offset,camera_id);
            }});

            document.getElementById('camera_button').addEventListener('click', () => {
                // Cycle through camera id up to 1 (0,1) for now
                if (camera_id >= 2) {
                    camera_id = 1;
                } else
                    camera_id++;
                document.getElementById('camera_button').innerText = `Camera ${camera_id}`;
                offset = 0;
                getLatestOffset(offset,camera_id);
            });

            document.getElementById('day_week_month').addEventListener('click', () => {
                if (mode === "day") {
                    mode = "week";
                    document.getElementById('day_week_month').innerText = "week";
                } else if (mode === "week") {
                    mode = "month";
                    document.getElementById('day_week_month').innerText = "month";
                } else {
                    mode = "day";
                    document.getElementById('day_week_month').innerText = "day";
                }
                offset = 0;
            });
            document.getElementById('slideshow').addEventListener('click', () => {
                get_slideshow(mode);
            });
            
            document.getElementById('timestamp').addEventListener('click', () => {
                getLatestOffset(0);
                offset = 0;
            });
            getLatestOffset(offset,camera_id);

            docymenbt
        </script>
    </body>
</html>